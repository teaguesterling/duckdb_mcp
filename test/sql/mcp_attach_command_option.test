# name: test/sql/mcp_attach_command_option.test
# description: Test COMMAND option in ATTACH for MCP client connections
# group: [sql]

# This test verifies the COMMAND option works in structured ATTACH mode.
# Since we can't actually connect to MCP servers in unit tests (no external
# processes), we test that the parsing works correctly by checking that
# the commands produce errors (either security rejection or connection
# failure depending on the security singleton state).

require duckdb_mcp

statement ok
LOAD duckdb_mcp;

# =============================================================================
# SECTION 1: COMMAND option triggers structured mode
# =============================================================================

# Using COMMAND option with transport should trigger structured mode.
# In non-permissive mode: security rejects the command.
# In permissive mode: connection fails (nonexistent binary).
# Either way, COMMAND was parsed â€” proven by the error rather than
# "unrecognized option" or success.
statement error
ATTACH '' AS cmd_test (TYPE mcp, COMMAND 'nonexistent_binary', TRANSPORT 'stdio');
----
MCP

# =============================================================================
# SECTION 2: COMMAND option without explicit transport
# =============================================================================

# COMMAND alone (no TRANSPORT) should still trigger structured mode
statement error
ATTACH '' AS cmd_only_test (TYPE mcp, COMMAND 'some_command');
----
MCP

# =============================================================================
# SECTION 3: Empty COMMAND falls back to path
# =============================================================================

# When COMMAND is empty but path is provided, path is used as fallback.
# The error proves parsing succeeded (path was accepted as the command).
statement error
ATTACH 'fallback_path' AS fallback_test (TYPE mcp, COMMAND '', TRANSPORT 'stdio');
----
MCP
