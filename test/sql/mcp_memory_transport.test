# name: test/sql/mcp_memory_transport.test
# description: Comprehensive MCP server tests using memory transport
# group: [duckdb_mcp]

# Load the MCP extension
require duckdb_mcp

statement ok
LOAD duckdb_mcp;

# =============================================================================
# SETUP: Force clean state
# =============================================================================

statement ok
SELECT mcp_server_stop(true);

# =============================================================================
# SECTION 1: Basic Server Lifecycle
# =============================================================================

# Test server start with memory transport
query I
SELECT mcp_server_start('memory');
----
{'success': true, 'running': true, 'message': 'MCP server started on memory transport (background mode)', 'transport': memory, 'listen': localhost, 'port': 0, 'background': true, 'requests_received': 0, 'responses_sent': 0}

# Test initialize handshake
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}') LIKE '%"result"%';
----
true

# Verify server name in initialize response
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":2,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}') LIKE '%DuckDB MCP Server%';
----
true

# Stop server
statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 2: Query Tool - All Formats
# =============================================================================

# Create test data first
statement ok
CREATE TABLE test_query AS SELECT 1 as id, 'hello' as message;

# Start fresh server
statement ok
SELECT mcp_server_stop(true);

statement ok
SELECT mcp_server_start('memory');

# Test query tool with default JSON format - verify structure (escaped JSON in content)
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":10,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT * FROM test_query"}}}') LIKE '%\"id\":%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":11,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT * FROM test_query"}}}') LIKE '%\"message\":\"hello\"%';
----
true

# Test query tool with explicit JSON format
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":12,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT id, message FROM test_query","format":"json"}}}') LIKE '%[{%';
----
true

# Test query tool with markdown format - should have table headers
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":20,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT id, message FROM test_query","format":"markdown"}}}') LIKE '%| id | message |%';
----
true

# Markdown should have separator row with alignment hints
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":21,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT id, message FROM test_query","format":"markdown"}}}') LIKE '%|---%';
----
true

# Test query tool with CSV format
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":30,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT id, message FROM test_query","format":"csv"}}}') LIKE '%id,message%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":31,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT id, message FROM test_query","format":"csv"}}}') LIKE '%1,hello%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 3: Describe Tool
# =============================================================================

statement ok
SELECT mcp_server_start('memory');

# Test describe tool on table - field names are escaped in JSON content
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":40,"method":"tools/call","params":{"name":"describe","arguments":{"table":"test_query"}}}') LIKE '%\"name\":\"id\"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":41,"method":"tools/call","params":{"name":"describe","arguments":{"table":"test_query"}}}') LIKE '%\"name\":\"message\"%';
----
true

# NOTE: describe query functionality has a bug (DESCRIBE stmt fails)
# This would need to be fixed in DescribeQuery implementation
# Skipping query describe test for now

statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 4: List Tables Tool
# =============================================================================

statement ok
SELECT mcp_server_start('memory');

# Test list_tables tool
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":50,"method":"tools/call","params":{"name":"list_tables","arguments":{}}}') LIKE '%test_query%';
----
true

# Create a view and test include_views
statement ok
CREATE VIEW test_view AS SELECT * FROM test_query;

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":51,"method":"tools/call","params":{"name":"list_tables","arguments":{"include_views":true}}}') LIKE '%test_view%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 5: Database Info Tool
# =============================================================================

statement ok
SELECT mcp_server_start('memory');

# Test database_info tool - JSON is escaped in content
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":60,"method":"tools/call","params":{"name":"database_info","arguments":{}}}') LIKE '%\"databases\"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":61,"method":"tools/call","params":{"name":"database_info","arguments":{}}}') LIKE '%\"tables\"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":62,"method":"tools/call","params":{"name":"database_info","arguments":{}}}') LIKE '%\"extensions\"%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 6: Resources List
# =============================================================================

statement ok
SELECT mcp_server_start('memory');

# Test resources/list (should be empty initially)
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":70,"method":"resources/list","params":{}}') LIKE '%"resources"%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 7: Error Handling
# =============================================================================

statement ok
SELECT mcp_server_start('memory');

# Test invalid method
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":80,"method":"invalid/method","params":{}}') LIKE '%"error"%';
----
true

# Test malformed JSON
query I
SELECT mcp_server_send_request('not valid json') LIKE '%"error"%';
----
true

# Test query with SQL error
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":81,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT * FROM nonexistent_table"}}}') LIKE '%error%';
----
true

# Test unknown tool
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":82,"method":"tools/call","params":{"name":"unknown_tool","arguments":{}}}') LIKE '%error%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 8: Multiple Request Sequence (Stateful Test)
# =============================================================================

statement ok
SELECT mcp_server_start('memory');

# Verify multi-request sequence works (server maintains state)
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":90,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}') LIKE '%"result"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":91,"method":"tools/list","params":{}}') LIKE '%"tools"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":92,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT 1+1 as sum"}}}') LIKE '%2%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":93,"method":"resources/list","params":{}}') LIKE '%"resources"%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 9: Tools List Verification
# =============================================================================

statement ok
SELECT mcp_server_start('memory');

# Verify all expected tools are present
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":100,"method":"tools/list","params":{}}') LIKE '%"query"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":101,"method":"tools/list","params":{}}') LIKE '%"describe"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":102,"method":"tools/list","params":{}}') LIKE '%"list_tables"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":103,"method":"tools/list","params":{}}') LIKE '%"database_info"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":104,"method":"tools/list","params":{}}') LIKE '%"export"%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# Cleanup
# =============================================================================

statement ok
DROP VIEW IF EXISTS test_view;

statement ok
DROP TABLE IF EXISTS test_query;

statement ok
SELECT mcp_server_stop(true);
