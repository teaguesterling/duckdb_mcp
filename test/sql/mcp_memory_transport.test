# name: test/sql/mcp_memory_transport.test
# description: Comprehensive MCP server tests using memory transport
# group: [duckdb_mcp]

# Load the MCP extension
require duckdb_mcp

statement ok
LOAD duckdb_mcp;

# =============================================================================
# SETUP: Force clean state
# =============================================================================

statement ok
SELECT mcp_server_stop(true);

# =============================================================================
# SECTION 1: Basic Server Lifecycle
# =============================================================================

# Test server start with memory transport
query I
SELECT mcp_server_start('memory');
----
{'success': true, 'running': true, 'message': 'MCP server started on memory transport (background mode)', 'transport': memory, 'listen': localhost, 'port': 0, 'background': true, 'requests_received': 0, 'responses_sent': 0, 'errors_returned': 0}

# Test initialize handshake - verify MCP spec compliance
# See: https://modelcontextprotocol.io/specification/2024-11-05/basic/lifecycle

# Initialize response must have "result" key
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}') LIKE '%"result"%';
----
true

# Initialize response must have protocolVersion at top level of result
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":2,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}') LIKE '%"protocolVersion":"2024-11-05"%';
----
true

# Initialize response must have serverInfo object
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":3,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}') LIKE '%"serverInfo":{%';
----
true

# serverInfo must contain name
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":4,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}') LIKE '%DuckDB MCP Server%';
----
true

# capabilities.tools must be an object (not a boolean)
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":5,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}') LIKE '%"tools":{%';
----
true

# capabilities.resources must be an object (not a boolean)
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":6,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}') LIKE '%"resources":{%';
----
true

# =============================================================================
# SECTION 1b: Notifications (no response expected per JSON-RPC 2.0 spec)
# =============================================================================

# notifications/initialized - sent by client after receiving initialize response
# Per MCP spec, server should accept this without returning an error
# Note: notifications have no "id" field and don't expect a response
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","method":"notifications/initialized","params":{}}') NOT LIKE '%error%';
----
true

# notifications/cancelled - client cancelling a request (we accept but don't act on it)
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","method":"notifications/cancelled","params":{"requestId":"123","reason":"test"}}') NOT LIKE '%error%';
----
true

# notifications/progress - progress updates (ignored by server)
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","method":"notifications/progress","params":{"progressToken":"abc","progress":50}}') NOT LIKE '%error%';
----
true

# Unknown notification should also not return an error (silently ignored per spec)
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","method":"notifications/unknown","params":{}}') NOT LIKE '%Method not found%';
----
true

# Stop server
statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 2: Query Tool - All Formats
# =============================================================================

# Create test data first
statement ok
CREATE TABLE test_query AS SELECT 1 as id, 'hello' as message;

# Start fresh server
statement ok
SELECT mcp_server_stop(true);

statement ok
SELECT mcp_server_start('memory');

# Test query tool with default JSON format - verify structure (escaped JSON in content)
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":10,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT * FROM test_query"}}}') LIKE '%\"id\":%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":11,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT * FROM test_query"}}}') LIKE '%\"message\":\"hello\"%';
----
true

# Test query tool with explicit JSON format
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":12,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT id, message FROM test_query","format":"json"}}}') LIKE '%[{%';
----
true

# Test query tool with markdown format - should have table headers
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":20,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT id, message FROM test_query","format":"markdown"}}}') LIKE '%| id | message |%';
----
true

# Markdown should have separator row with alignment hints
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":21,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT id, message FROM test_query","format":"markdown"}}}') LIKE '%|---%';
----
true

# Test query tool with CSV format
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":30,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT id, message FROM test_query","format":"csv"}}}') LIKE '%id,message%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":31,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT id, message FROM test_query","format":"csv"}}}') LIKE '%1,hello%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 3: Describe Tool
# =============================================================================

statement ok
SELECT mcp_server_start('memory');

# Test describe tool on table - field names are escaped in JSON content
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":40,"method":"tools/call","params":{"name":"describe","arguments":{"table":"test_query"}}}') LIKE '%\"name\":\"id\"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":41,"method":"tools/call","params":{"name":"describe","arguments":{"table":"test_query"}}}') LIKE '%\"name\":\"message\"%';
----
true

# Test describe tool on query (uses DESCRIBE (subquery) syntax)
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":42,"method":"tools/call","params":{"name":"describe","arguments":{"query":"SELECT 42 as answer, 100 as value"}}}') LIKE '%\"name\":\"answer\"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":43,"method":"tools/call","params":{"name":"describe","arguments":{"query":"SELECT 42 as answer, 100 as value"}}}') LIKE '%\"name\":\"value\"%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 4: List Tables Tool
# =============================================================================

statement ok
SELECT mcp_server_start('memory');

# Test list_tables tool
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":50,"method":"tools/call","params":{"name":"list_tables","arguments":{}}}') LIKE '%test_query%';
----
true

# Create a view and test include_views
statement ok
CREATE VIEW test_view AS SELECT * FROM test_query;

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":51,"method":"tools/call","params":{"name":"list_tables","arguments":{"include_views":true}}}') LIKE '%test_view%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 5: Database Info Tool
# =============================================================================

statement ok
SELECT mcp_server_start('memory');

# Test database_info tool - JSON is escaped in content
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":60,"method":"tools/call","params":{"name":"database_info","arguments":{}}}') LIKE '%\"databases\"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":61,"method":"tools/call","params":{"name":"database_info","arguments":{}}}') LIKE '%\"tables\"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":62,"method":"tools/call","params":{"name":"database_info","arguments":{}}}') LIKE '%\"extensions\"%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 6: Resources List
# =============================================================================

statement ok
SELECT mcp_server_start('memory');

# Test resources/list (should be empty initially)
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":70,"method":"resources/list","params":{}}') LIKE '%"resources"%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 7: Error Handling
# =============================================================================

statement ok
SELECT mcp_server_start('memory');

# Test invalid method
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":80,"method":"invalid/method","params":{}}') LIKE '%"error"%';
----
true

# Test malformed JSON
query I
SELECT mcp_server_send_request('not valid json') LIKE '%"error"%';
----
true

# Test query with SQL error
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":81,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT * FROM nonexistent_table"}}}') LIKE '%error%';
----
true

# Test unknown tool
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":82,"method":"tools/call","params":{"name":"unknown_tool","arguments":{}}}') LIKE '%error%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 8: Multiple Request Sequence (Stateful Test)
# =============================================================================

statement ok
SELECT mcp_server_start('memory');

# Verify multi-request sequence works (server maintains state)
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":90,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}') LIKE '%"result"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":91,"method":"tools/list","params":{}}') LIKE '%"tools"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":92,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT 1+1 as sum"}}}') LIKE '%2%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":93,"method":"resources/list","params":{}}') LIKE '%"resources"%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 9: Tools List Verification
# =============================================================================

statement ok
SELECT mcp_server_start('memory');

# Verify all expected tools are present
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":100,"method":"tools/list","params":{}}') LIKE '%"query"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":101,"method":"tools/list","params":{}}') LIKE '%"describe"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":102,"method":"tools/list","params":{}}') LIKE '%"list_tables"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":103,"method":"tools/list","params":{}}') LIKE '%"database_info"%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":104,"method":"tools/list","params":{}}') LIKE '%"export"%';
----
true

# =============================================================================
# SECTION 10: Tools List - JSON Schema Format Compliance
# =============================================================================

# inputSchema must be an object, not a string
# If it's a string, it would look like: "inputSchema":"{\"type..." (escaped quotes)
# If it's an object, it looks like: "inputSchema":{"type"... (no escape before type)
# This test will FAIL if inputSchema is a string, PASS if it's an object
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":110,"method":"tools/list","params":{}}') LIKE '%"inputSchema":{"type":"object"%';
----
true

# inputSchema.properties must be an object with property names as keys (not an array)
# Verify "sql" appears as a property key followed by an object (type definition)
# NOT as {"name":"sql"...} which would be the array format
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":111,"method":"tools/list","params":{}}') LIKE '%"sql":{"type":"string"}%';
----
true

# Verify properties is followed by { (object start), not [ (array start)
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":112,"method":"tools/list","params":{}}') LIKE '%"properties":{%';
----
true

# Verify inputSchema has required array
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":113,"method":"tools/list","params":{}}') LIKE '%"required":%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# SECTION 11: Unsupported Format Validation (Issue #8)
# =============================================================================

statement ok
SELECT mcp_server_start('memory');

# Test unsupported format returns error, not fallback data
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":120,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT 1","format":"jsonl"}}}') LIKE '%Unsupported format%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":121,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT 1","format":"table"}}}') LIKE '%Unsupported format%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":122,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT 1","format":"box"}}}') LIKE '%Unsupported format%';
----
true

# Verify supported formats still work
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":123,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT 42 as num","format":"json"}}}') LIKE '%42%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":124,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT 42 as num","format":"markdown"}}}') LIKE '%| num |%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":125,"method":"tools/call","params":{"name":"query","arguments":{"sql":"SELECT 42 as num","format":"csv"}}}') LIKE '%num%';
----
true

# Test export tool format validation
query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":130,"method":"tools/call","params":{"name":"export","arguments":{"query":"SELECT 1","format":"parquet"}}}') LIKE '%Unsupported format%';
----
true

query I
SELECT mcp_server_send_request('{"jsonrpc":"2.0","id":131,"method":"tools/call","params":{"name":"export","arguments":{"query":"SELECT 1","format":"jsonl"}}}') LIKE '%Unsupported format%';
----
true

statement ok
SELECT mcp_server_stop();

# =============================================================================
# Cleanup
# =============================================================================

statement ok
DROP VIEW IF EXISTS test_view;

statement ok
DROP TABLE IF EXISTS test_query;

statement ok
SELECT mcp_server_stop(true);
